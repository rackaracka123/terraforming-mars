# Backend Testing Makefile
# Run from backend/ directory

.PHONY: test test-verbose test-coverage test-quick test-service test-integration test-websocket format lint clean

# Main test command
test:
	@echo "ğŸ§ª Running all backend tests..."
	go test ./test/...

test-backend:
	@echo "ğŸ§ª Running all backend tests..."
	go test ./test/...

# Test with verbose output
test-verbose:
	@echo "ğŸ§ª Running backend tests (verbose)..."
	go test -v ./test/...

# Test with coverage report
test-coverage:
	@echo "ğŸ§ª Running backend tests with coverage..."
	go test -v -coverprofile=coverage.out ./test/...
	go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“Š Coverage report: coverage.html"

# Quick test suite for development iteration
test-quick:
	@echo "âš¡ Running quick test suite..."
	@go test ./test/service/... && echo "âœ… Service tests passed" || echo "âŒ Service tests failed"
	@go test ./test/delivery/websocket/hub_test.go && echo "âœ… Hub tests passed" || echo "âŒ Hub tests failed"
	@go test ./test/delivery/websocket/message_test.go && echo "âœ… Message tests passed" || echo "âŒ Message tests failed"
	@go test ./test/delivery/websocket/client_test.go && echo "âœ… Client tests passed" || echo "âŒ Client tests failed"

# Test specific categories
test-service:
	@echo "ğŸ”§ Running service layer tests..."
	go test ./test/service/...

test-integration:
	@echo "ğŸ”— Running integration tests..."
	go test ./test/integration/...

test-websocket:
	@echo "ğŸŒ Running WebSocket tests..."
	go test ./test/delivery/websocket/...

# Code quality
format:
	@echo "ğŸ¨ Formatting Go code..."
	gofmt -s -w .
	@echo "âœ… Backend formatting complete"

lint:
	@echo "ğŸ” Running Go fmt..."
	go fmt ./...
	@echo "âœ… Backend linting complete"

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning test artifacts..."
	rm -f coverage.out coverage.html
	go clean
	@echo "âœ… Cleanup complete"

# Run specific test files (usage: make test-file FILE=test/service/game_service_test.go)
test-file:
	@echo "ğŸ¯ Running specific test file: $(FILE)"
	go test ./$(FILE)

# Run tests with race detection
test-race:
	@echo "ğŸ Running tests with race detection..."
	go test -race ./test/...

# Watch for changes and run tests (requires entr: apt install entr)
test-watch:
	@echo "ğŸ‘€ Watching for Go file changes and running tests..."
	find . -name "*.go" | entr -c make test-quick